#include <Arduino.h>
#include <Wire.h>
#include "MPU9250.h"

MPU9250 mpu;

void print_sensor_data() {
    // Print Roll, Pitch, Yaw
    Serial.print(mpu.getRoll());
    Serial.print(",");
    Serial.print(mpu.getPitch());
    Serial.print(",");
    Serial.println(mpu.getYaw(), 2);
    
    // // Print Accelerometer data (in g)
    // Serial.print(" | Acc X: ");
    // Serial.print(mpu.getAccX(), 3);
    // Serial.print(" Y: ");
    // Serial.print(mpu.getAccY(), 3);
    // Serial.print(" Z: ");
    // Serial.print(mpu.getAccZ(), 3);
    
    // // Print Gyroscope data (in deg/s)
    // Serial.print(" | Gyro X: ");
    // Serial.print(mpu.getGyroX(), 2);
    // Serial.print(" Y: ");
    // Serial.print(mpu.getGyroY(), 2);
    // Serial.print(" Z: ");
    // Serial.print(mpu.getGyroZ(), 2);
    
    // // Print Magnetometer data (in mG)
    // Serial.print(" | Mag X: ");
    // Serial.print(mpu.getMagX(), 2);
    // Serial.print(" Y: ");
    // Serial.print(mpu.getMagY(), 2);
    // Serial.print(" Z: ");
    // Serial.println(mpu.getMagZ(), 2);
}

void print_calibration() {
    Serial.println("\n< calibration parameters >");
    Serial.println("accel bias [g]: ");
    Serial.print(mpu.getAccBiasX() * 1000.f / (float)MPU9250::CALIB_ACCEL_SENSITIVITY);
    Serial.print(", ");
    Serial.print(mpu.getAccBiasY() * 1000.f / (float)MPU9250::CALIB_ACCEL_SENSITIVITY);
    Serial.print(", ");
    Serial.print(mpu.getAccBiasZ() * 1000.f / (float)MPU9250::CALIB_ACCEL_SENSITIVITY);
    Serial.println();
    
    Serial.println("gyro bias [deg/s]: ");
    Serial.print(mpu.getGyroBiasX() / (float)MPU9250::CALIB_GYRO_SENSITIVITY);
    Serial.print(", ");
    Serial.print(mpu.getGyroBiasY() / (float)MPU9250::CALIB_GYRO_SENSITIVITY);
    Serial.print(", ");
    Serial.print(mpu.getGyroBiasZ() / (float)MPU9250::CALIB_GYRO_SENSITIVITY);
    Serial.println();
    
    Serial.println("mag bias [mG]: ");
    Serial.print(mpu.getMagBiasX());
    Serial.print(", ");
    Serial.print(mpu.getMagBiasY());
    Serial.print(", ");
    Serial.print(mpu.getMagBiasZ());
    Serial.println();
    
    Serial.println("mag scale []: ");
    Serial.print(mpu.getMagScaleX());
    Serial.print(", ");
    Serial.print(mpu.getMagScaleY());
    Serial.print(", ");
    Serial.print(mpu.getMagScaleZ());
    Serial.println();
}

void setup() {
    Serial.begin(115200);
    
    // For ESP32, specify the I2C pins if they're non-standard
    // Wire.begin(SDA_PIN, SCL_PIN);  // e.g., Wire.begin(21, 22);
    Wire.begin();
    
    delay(2000);
    
    Serial.println("Initializing MPU9250...");

    // Use setup() without checking return value first, 
    // then check isConnected()
    mpu.setup(0x68);  // or 0x69 depending on your AD0 pin
    
    delay(1000);
    
    // Check if connected
    if (!mpu.isConnected()) {
        Serial.println("MPU9250 connection failed!");
        Serial.println("Please check:");
        Serial.println("1. Wiring (SDA, SCL, VCC, GND)");
        Serial.println("2. I2C address (0x68 or 0x69)");
        Serial.println("3. Pull-up resistors on SDA/SCL");
        while (1) {
            delay(1000);
        }
    }
    
    Serial.println("MPU9250 connected successfully!");
    
    // Check if magnetometer is connected
    if (!mpu.isConnectedAK8963()) {
        Serial.println("Warning: Magnetometer (AK8963) not detected!");
        Serial.println("Gyro and Accel will work, but Mag won't.");
    }

    // Calibrate anytime you want to
    Serial.println("\nAccel Gyro calibration will start in 5sec.");
    Serial.println("Please leave the device still on a flat plane.");
    mpu.verbose(true);
    delay(5000);
    mpu.calibrateAccelGyro();

    Serial.println("\nMag calibration will start in 5sec.");
    Serial.println("Please wave device in a figure eight until done.");
    delay(5000);
    mpu.calibrateMag();

    print_calibration();
    mpu.verbose(false);
    
    Serial.println("\n=== Starting sensor readings ===\n");
}

void loop() {
    if (mpu.update()) {
        static uint32_t prev_ms = millis();
        if (millis() > prev_ms + 100) {  // Update every 100ms
            print_sensor_data();
            prev_ms = millis();
        }
    }
}


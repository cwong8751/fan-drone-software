<!DOCTYPE html>
<html>
<head>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <script src='https://cdn.jsdelivr.net/npm/chart.js'></script>
    <style>
        body { 
            font-family: 'Segoe UI', Helvetica, Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: #0a0e27; 
            color: #fff; 
        }
        h1 { 
            text-align: center; 
            color: #00d4ff; 
            margin-bottom: 30px; 
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
        }
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
            margin-bottom: 20px; 
        }
        .card { 
            background: #1a1f3a; 
            border-radius: 10px; 
            padding: 20px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); 
        }
        .card h2 { 
            margin: 0 0 15px 0; 
            color: #00d4ff; 
            font-size: 18px; 
            border-bottom: 2px solid #00d4ff; 
            padding-bottom: 8px; 
        }
        .metric { 
            display: flex; 
            justify-content: space-between; 
            padding: 8px 0; 
            border-bottom: 1px solid #2a2f4a; 
        }
        .metric:last-child { 
            border-bottom: none; 
        }
        .metric-label { 
            color: #8892b0; 
            font-size: 14px; 
        }
        .metric-value { 
            color: #fff; 
            font-weight: bold; 
            font-size: 16px; 
        }
        .status-armed { 
            color: #ff4444; 
        }
        .status-disarmed { 
            color: #44ff44; 
        }
        canvas { 
            max-width: 100%; 
            height: auto; 
        }
        .chart-card { 
            grid-column: 1 / -1; 
        }
    </style>
</head>
<body>
    <div class='container'>
        <h1>Flight Controller Dashboard</h1>
        
        <div class='grid'>
            
            <!-- Attitude Card -->
            <div class='card'>
                <h2>Altitude</h2>
                <div class='metric'>
                    <span class='metric-label'>Roll:</span>
                    <span class='metric-value' id='roll'>--</span>
                </div>
                <div class='metric'>
                    <span class='metric-label'>Pitch:</span>
                    <span class='metric-value' id='pitch'>--</span>
                </div>
                <div class='metric'>
                    <span class='metric-label'>Yaw:</span>
                    <span class='metric-value' id='yaw'>--</span>
                </div>
            </div>
            
            <!-- Rates Card -->
            <div class='card'>
                <h2>Angular Rates</h2>
                <div class='metric'>
                    <span class='metric-label'>Roll Rate:</span>
                    <span class='metric-value' id='roll_rate'>--</span>
                </div>
                <div class='metric'>
                    <span class='metric-label'>Pitch Rate:</span>
                    <span class='metric-value' id='pitch_rate'>--</span>
                </div>
                <div class='metric'>
                    <span class='metric-label'>Yaw Rate:</span>
                    <span class='metric-value' id='yaw_rate'>--</span>
                </div>
            </div>
            
            <!-- Acceleration Card -->
            <div class='card'>
                <h2>Acceleration</h2>
                <div class='metric'>
                    <span class='metric-label'>X-axis:</span>
                    <span class='metric-value' id='accel_x'>--</span>
                </div>
                <div class='metric'>
                    <span class='metric-label'>Y-axis:</span>
                    <span class='metric-value' id='accel_y'>--</span>
                </div>
                <div class='metric'>
                    <span class='metric-label'>Z-axis:</span>
                    <span class='metric-value' id='accel_z'>--</span>
                </div>
            </div>
            
            <!-- Controls Card -->
            <div class='card'>
                <h2>Controls</h2>
                <div class='metric'>
                    <span class='metric-label'>Throttle:</span>
                    <span class='metric-value' id='throttle'>--</span>
                </div>
                <div class='metric'>
                    <span class='metric-label'>Armed:</span>
                    <span class='metric-value' id='armed'>--</span>
                </div>
            </div>
            
            <!-- Performance Card -->
            <div class='card'>
                <h2>Performance</h2>
                <div class='metric'>
                    <span class='metric-label'>Loop Rate:</span>
                    <span class='metric-value' id='loop_hz'>--</span>
                </div>
                <div class='metric'>
                    <span class='metric-label'>Loop Time:</span>
                    <span class='metric-value' id='loop_time'>--</span>
                </div>
                <div class='metric'>
                    <span class='metric-label'>Uptime:</span>
                    <span class='metric-value' id='uptime'>--</span>
                </div>
            </div>
            
        </div>
        
        <!-- Chart Card -->
        <div class='card chart-card'>
            <h2>Altitude History</h2>
            <canvas id='chart' width='400' height='200'></canvas>
        </div>
        
    </div>
    
    <script>
        const ctx = document.getElementById('chart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line', 
            data: {
                labels: [], 
                datasets: [
                    {
                        label: 'Roll', 
                        borderColor: '#ff6384', 
                        backgroundColor: 'rgba(255,99,132,0.1)', 
                        fill: true, 
                        data: [], 
                        tension: 0.4
                    },
                    {
                        label: 'Pitch', 
                        borderColor: '#36a2eb', 
                        backgroundColor: 'rgba(54,162,235,0.1)', 
                        fill: true, 
                        data: [], 
                        tension: 0.4
                    },
                    {
                        label: 'Yaw', 
                        borderColor: '#ffcd56', 
                        backgroundColor: 'rgba(255,205,86,0.1)', 
                        fill: true, 
                        data: [], 
                        tension: 0.4
                    }
                ]
            }, 
            options: {
                responsive: true, 
                animation: false,
                scales: {
                    y: {
                        min: -180, 
                        max: 180, 
                        grid: {color: '#2a2f4a'}, 
                        ticks: {color: '#8892b0'}
                    }, 
                    x: {
                        grid: {color: '#2a2f4a'}, 
                        ticks: {color: '#8892b0'}
                    }
                },
                plugins: {
                    legend: {
                        labels: {color: '#fff'}
                    }
                }
            }
        });
        
        function formatTime(ms) {
            const s = Math.floor(ms / 1000);
            const m = Math.floor(s / 60);
            const h = Math.floor(m / 60);
            return h + ':' + (m % 60).toString().padStart(2, '0') + ':' + (s % 60).toString().padStart(2, '0');
        }
        
        function fetchData() {
            fetch('/data')
                .then(r => r.json())
                .then(d => {
                    // Update attitude values
                    document.getElementById('roll').textContent = d.attitude.roll.toFixed(2) + '°';
                    document.getElementById('pitch').textContent = d.attitude.pitch.toFixed(2) + '°';
                    document.getElementById('yaw').textContent = d.attitude.yaw.toFixed(2) + '°';
                    
                    // Update rates
                    document.getElementById('roll_rate').textContent = d.rates.roll_rate.toFixed(2) + '°/s';
                    document.getElementById('pitch_rate').textContent = d.rates.pitch_rate.toFixed(2) + '°/s';
                    document.getElementById('yaw_rate').textContent = d.rates.yaw_rate.toFixed(2) + '°/s';
                    
                    // Update acceleration
                    document.getElementById('accel_x').textContent = d.acceleration.x.toFixed(3) + ' g';
                    document.getElementById('accel_y').textContent = d.acceleration.y.toFixed(3) + ' g';
                    document.getElementById('accel_z').textContent = d.acceleration.z.toFixed(3) + ' g';
                    
                    // Update controls
                    document.getElementById('throttle').textContent = d.controls.throttle.toFixed(1) + '%';
                    const armed = document.getElementById('armed');
                    armed.textContent = d.controls.armed ? 'ARMED' : 'DISARMED';
                    armed.className = d.controls.armed ? 'metric-value status-armed' : 'metric-value status-disarmed';
                    
                    // Update performance
                    document.getElementById('loop_hz').textContent = d.performance.loop_hz.toFixed(1) + ' Hz';
                    document.getElementById('loop_time').textContent = d.performance.loop_time_us + ' μs';
                    document.getElementById('uptime').textContent = formatTime(d.timestamp);
                    
                    // Update chart
                    const t = new Date().toLocaleTimeString();
                    chart.data.labels.push(t);
                    chart.data.datasets[0].data.push(d.attitude.roll);
                    chart.data.datasets[1].data.push(d.attitude.pitch);
                    chart.data.datasets[2].data.push(d.attitude.yaw);
                    
                    if (chart.data.labels.length > 50) {
                        chart.data.labels.shift();
                        chart.data.datasets.forEach(s => s.data.shift());
                    }
                    
                    chart.update();
                })
                .catch(err => console.error('Fetch error:', err));
        }
        
        setInterval(fetchData, 500);
        fetchData();
    </script>
</body>
</html>